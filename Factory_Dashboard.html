<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirCore Dynamics - ì œì¡° ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
        background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        color: #e0e0e0;
        min-height: 100vh;
    }

    .header {
        background: rgba(28, 49, 58, 0.85);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        box-shadow: 0 2px 20px rgba(77, 208, 225, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 1px solid rgba(77, 208, 225, 0.2);
    }

    .logo {
        font-size: 1.8rem;
        font-weight: bold;
        color: #ffffff;
    }

    .time-display {
        font-size: 1.1rem;
        color: #e0e0e0;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
    }

    .tab-navigation {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 0.5rem;
        flex-wrap: wrap;
    }

    .tab-btn {
        padding: 0.75rem 1.5rem;
        background: transparent;
        color: #e0e0e0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .tab-btn.active {
        background: rgba(77, 208, 225, 0.3);
        color: #ffffff;
        backdrop-filter: blur(10px);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.5s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .card {
        background: rgba(28, 49, 58, 0.85);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        border: 1px solid rgba(77, 208, 225, 0.2);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
    }

    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #f5f5f5;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }
    
    .status-good { background-color: #27ae60; }
    .status-warning { background-color: #f39c12; }
    .status-danger { background-color: #e74c3c; }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(39, 174, 96, 0); }
        100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); }
    }

    .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0.5rem 0;
        padding: 0.5rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }

    .metric-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #4dd0e1;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
        overflow: hidden;
        margin: 0.5rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #0097a7, #4dd0e1);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    /* --- âœ¨ 3D ê³µì¥ ë·°ì–´ CSS âœ¨ --- */
    .factory-container {
        grid-column: span 2;
        height: 400px;
        position: relative;
        overflow: hidden;
    }

    #factoryViewer {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        background: #0f2027;
    }

    .factory-controls {
        position: absolute;
        top: 1rem;
        right: 1rem;
        display: flex;
        gap: 0.5rem;
    }

    .factory-btn {
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .machine-info-panel {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        max-width: 300px;
        transition: opacity 0.3s ease;
    }
    .machine-info-panel.hidden {
        opacity: 0;
        pointer-events: none;
    }
    /* --- âœ¨ 3D ë·°ì–´ CSS ì™„ë£Œ âœ¨ --- */

    .equipment-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .equipment-item {
        text-align: center;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        transition: transform 0.3s ease;
        cursor: pointer;
    }

    .equipment-item:hover {
        transform: scale(1.05);
    }

    .equipment-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .alert-box {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        animation: alertPulse 2s infinite;
    }

    @keyframes alertPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }

    .wide-card {
        grid-column: span 2;
    }

    .production-chart {
        height: 200px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        margin: 1rem 0;
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        padding: 1rem;
    }

    .chart-bar {
        background: linear-gradient(0deg, #0097a7, #4dd0e1);
        border-radius: 4px 4px 0 0;
        width: 40px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        color: white;
        font-size: 0.7rem;
        font-weight: bold;
        padding-bottom: 0.25rem;
        transition: height 1s ease;
    }

    .line-selector {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .line-btn {
        padding: 0.5rem 1rem;
        background: rgba(0, 0, 0, 0.2);
        border: 2px solid transparent;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #e0e0e0;
    }

    .line-btn.active {
        background: #00bcd4;
        color: white;
        border-color: #0097a7;
    }

    @media (max-width: 1200px) {
        .factory-container {
            grid-column: span 1;
        }
        .wide-card {
            grid-column: span 1;
        }
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        .tab-navigation {
            justify-content: center;
        }
    }
</style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="logo">ğŸ­ AirCore Dynamics</div>
            <div class="time-display" id="currentTime"></div>
        </div>

        <div class="container">
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="setActiveTab('dashboard')">ëŒ€ì‹œë³´ë“œ</button>
                <button class="tab-btn" onclick="setActiveTab('lines')">ë¼ì¸ë³„ ìƒì„¸</button>
                <button class="tab-btn" onclick="setActiveTab('prediction')">ì˜ˆì¸¡ ë¶„ì„</button>
                <button class="tab-btn" onclick="setActiveTab('inventory')">ì¬ê³ /ì¶œí•˜</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div class="dashboard-grid">
                    <div class="card factory-container">
                        <div class="card-header">
                            <div class="card-title">ğŸ­ 3D ê³µì¥ ë·°ì–´</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div id="factoryViewer"></div>
                        <div class="factory-controls">
                            <button class="factory-btn" onclick="toggleAnimation()">
                                <span id="animationBtn">â¸ï¸ ì¼ì‹œì •ì§€</span>
                            </button>
                            <button class="factory-btn" onclick="zoomIn()">â•</button>
                            <button class="factory-btn" onclick="zoomOut()">â–</button>
                            <button class="factory-btn" onclick="openFullscreenView()">ğŸ–¼ï¸ ì „ì²´í™”ë©´</button>
                        </div>
                        <div class="machine-info-panel hidden" id="machineInfoPanel">
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“Š ì‹¤ì‹œê°„ ìƒì‚° í˜„í™©</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="metric">
                            <span>ê¸ˆì¼ ìƒì‚°ëŸ‰</span>
                            <span class="metric-value" id="dailyProduction">847 / 1,100</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 77%"></div>
                        </div>
                        <div class="metric">
                            <span>ì „ì²´ ê°€ë™ë¥ </span>
                            <span class="metric-value" id="overallEfficiency">84.2%</span>
                        </div>
                        <div class="production-chart" id="productionChart">
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ¯ í’ˆì§ˆ í˜„í™©</div>
                            <div class="status-indicator status-warning"></div>
                        </div>
                        <div class="metric">
                            <span>ê²€ì‚¬ í†µê³¼ìœ¨</span>
                            <span class="metric-value" id="passRate">96.8%</span>
                        </div>
                        <div class="metric">
                            <span>ë¶ˆëŸ‰ë¥ </span>
                            <span class="metric-value" style="color: #e74c3c;" id="defectRate">3.2%</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">ì£¼ìš” ë¶ˆëŸ‰ ìœ í˜•:</div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;" id="defectTypes">
                                â€¢ ê¸°ê³µ: 1.8%<br>
                                â€¢ ì¹˜ìˆ˜ì˜¤ì°¨: 0.9%<br>
                                â€¢ ì¡°ë¦½ë¶ˆëŸ‰: 0.5%
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">âš™ï¸ ì„¤ë¹„ ìƒíƒœ</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="equipment-status">
                            <div class="equipment-item" onclick="selectEquipment('furnace')">
                                <div class="equipment-icon">ğŸ”¥</div>
                                <div style="font-size: 0.8rem;">ìš©í•´ë¡œ</div>
                                <div style="color: #27ae60; font-size: 0.8rem;">ì •ìƒ</div>
                            </div>
                            <div class="equipment-item" onclick="selectEquipment('cnc')">
                                <div class="equipment-icon">âš¡</div>
                                <div style="font-size: 0.8rem;">CNC</div>
                                <div style="color: #27ae60; font-size: 0.8rem;">ì •ìƒ</div>
                            </div>
                            <div class="equipment-item" onclick="selectEquipment('inspector')">
                                <div class="equipment-icon">ğŸ”</div>
                                <div style="font-size: 0.8rem;">ê²€ì‚¬ëŒ€</div>
                                <div style="color: #f39c12; font-size: 0.8rem;">ì£¼ì˜</div>
                            </div>
                            <div class="equipment-item" onclick="selectEquipment('robot')">
                                <div class="equipment-icon">ğŸ¤–</div>
                                <div style="font-size: 0.8rem;">ì¡°ë¦½ê¸°</div>
                                <div style="color: #27ae60; font-size: 0.8rem;">ì •ìƒ</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸŒ¡ï¸ í™˜ê²½ ëª¨ë‹ˆí„°ë§</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="metric">
                            <span>ì˜¨ë„</span>
                            <span class="metric-value" id="temperature">23.4Â°C</span>
                        </div>
                        <div class="metric">
                            <span>ìŠµë„</span>
                            <span class="metric-value" id="humidity">58.2%</span>
                        </div>
                        <div class="metric">
                            <span>ìš©í•´ë¡œ ì˜¨ë„</span>
                            <span class="metric-value" id="furnaceTemp">742Â°C</span>
                        </div>
                        <div class="metric">
                            <span>ì´ ì „ë ¥ ì†Œë¹„ëŸ‰</span>
                            <span class="metric-value" id="powerConsumption">245.7 kW</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸš¨ ìµœê·¼ ì•ŒëŒ</div>
                            <div class="status-indicator status-warning"></div>
                        </div>
                        <div class="alert-box">
                            <span class="alert-icon">âš ï¸</span>
                            <div>
                                <div style="font-weight: bold;">ê²€ì‚¬ëŒ€ #2 ì§„ë™ ì´ìƒ</div>
                                <div style="font-size: 0.8rem; opacity: 0.9;">2ë¶„ ì „</div>
                            </div>
                        </div>
                        <div style="background: rgba(243, 156, 18, 0.1); color: #f39c12; padding: 0.5rem; border-radius: 8px; margin: 0.5rem 0; font-size: 0.8rem;">
                            <span class="alert-icon">ğŸ”§</span>
                            CNC #3 ê³µêµ¬ êµì²´ í•„ìš” - 15ë¶„ ì „
                        </div>
                    </div>
                </div>
            </div>

            <div id="lines" class="tab-content">
                <div class="line-selector">
                    <button class="line-btn active" onclick="selectLine('casting')">ì£¼ì¡° ë¼ì¸</button>
                    <button class="line-btn" onclick="selectLine('machining')">ê°€ê³µ ë¼ì¸</button>
                    <button class="line-btn" onclick="selectLine('inspection')">ê²€ì‚¬ ë¼ì¸</button>
                    <button class="line-btn" onclick="selectLine('assembly')">ì¡°ë¦½ ë¼ì¸</button>
                    <button class="line-btn" onclick="selectLine('packaging')">í¬ì¥/ì¶œí•˜</button>
                </div>
                <div class="dashboard-grid" id="lineDetailContent">
                </div>
            </div>

            <div id="prediction" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card wide-card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“ˆ ìƒì‚°ëŸ‰ ì˜ˆì¸¡</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="metric">
                            <span>ì˜ˆìƒ ì¼ì¼ ìƒì‚°ëŸ‰</span>
                            <span class="metric-value" id="expectedDaily">1,087ê°œ</span>
                        </div>
                        <div class="metric">
                            <span>ëª©í‘œ ë‹¬ì„±ë¥ </span>
                            <span class="metric-value" id="achievementRate">98.8%</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ” ë³‘ëª© êµ¬ê°„ ë¶„ì„</div>
                            <div class="status-indicator status-warning"></div>
                        </div>
                        <div style="font-size: 0.9rem;">
                            <div style="color: #e74c3c; margin: 0.5rem 0;">
                                <strong>ì£¼ìš” ë³‘ëª©:</strong> <span id="mainBottleneck">ê²€ì‚¬ ë¼ì¸</span>
                            </div>
                            <div style="color: #7f8c8d; font-size: 0.8rem;">
                                â€¢ í‰ê·  ëŒ€ê¸°ì‹œê°„: <span id="waitTime">8.3</span>ë¶„<br>
                                â€¢ ì²˜ë¦¬ì†ë„: <span id="processingSpeed">85</span>% ëª©í‘œëŒ€ë¹„<br>
                                â€¢ ê¶Œì¥ì‚¬í•­: <span id="recommendation">ê²€ì‚¬ëŒ€ ì¶”ê°€ ìš´ì˜</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="inventory" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸ“¦ í˜„ì¬ ì¬ê³ </div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="metric">
                            <span>ì™„ì œí’ˆ</span>
                            <span class="metric-value" id="finishedGoods">2,847ê°œ</span>
                        </div>
                        <div class="metric">
                            <span>ë°˜ì œí’ˆ</span>
                            <span class="metric-value" id="wip">394ê°œ</span>
                        </div>
                        <div class="metric">
                            <span>ì•ˆì „ ì¬ê³ ìœ¨</span>
                            <span class="metric-value" id="safetyStock">112%</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">ğŸšš ì¶œí•˜ í˜„í™©</div>
                            <div class="status-indicator status-good"></div>
                        </div>
                        <div class="metric">
                            <span>ê¸ˆì¼ ì¶œí•˜ëŸ‰</span>
                            <span class="metric-value" id="todayShipment">1,150ê°œ</span>
                        </div>
                        <div class="metric">
                            <span>ëŒ€ê¸° ì¶œí•˜ëŸ‰</span>
                            <span class="metric-value" id="pendingShipment">850ê°œ</span>
                        </div>
                        <div class="metric">
                            <span>ì˜ˆì • ì¶œí•˜</span>
                            <span class="metric-value" id="scheduledShipment">ë‚´ì¼ 1,200ê°œ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ë° ë°ì´í„° ---
let scene, camera, renderer, animationId, controls;
let raycaster, mouse;
let selectedLine = 'casting';

// --- 3D ë·°ì–´ ê´€ë ¨ ì „ì—­ ë³€ìˆ˜ ---
const factoryObjects = new THREE.Group();
let selectedObject = null;
const initialColors = new Map();
let animationRunning = true;

const processMachineInfo = [
    {PM_ID: 'PM001', Process_Name: 'ì£¼ì¡°', Machine_Name: 'ì£¼ì¡°ê¸°1', Standard_Cycle_Time: 3600, Description: 'ê¸ˆì† ìš©í•´ ë° ì£¼ì¡° ì¥ë¹„ 1í˜¸ê¸°'},
    {PM_ID: 'PM002', Process_Name: 'ì£¼ì¡°', Machine_Name: 'ì£¼ì¡°ê¸°2', Standard_Cycle_Time: 3600, Description: 'ê¸ˆì† ìš©í•´ ë° ì£¼ì¡° ì¥ë¹„ 2í˜¸ê¸°'},
    {PM_ID: 'PM003', Process_Name: 'ì£¼ì¡°', Machine_Name: 'ì£¼ì¡°ê¸°3', Standard_Cycle_Time: 3600, Description: 'ê¸ˆì† ìš©í•´ ë° ì£¼ì¡° ì¥ë¹„ 3í˜¸ê¸°'},
    {PM_ID: 'PM004', Process_Name: 'ê°€ê³µ', Machine_Name: 'ê°€ê³µê¸°1', Standard_Cycle_Time: 1800, Description: 'ì •ë°€ ê°€ê³µ ë° ì„±í˜• ì¥ë¹„ 1í˜¸ê¸°'},
    {PM_ID: 'PM005', Process_Name: 'ê°€ê³µ', Machine_Name: 'ê°€ê³µê¸°2', Standard_Cycle_Time: 1800, Description: 'ì •ë°€ ê°€ê³µ ë° ì„±í˜• ì¥ë¹„ 2í˜¸ê¸°'},
    {PM_ID: 'PM006', Process_Name: 'ê²€ì‚¬', Machine_Name: 'ê²€ì‚¬ì¥ë¹„', Standard_Cycle_Time: 900, Description: 'í’ˆì§ˆ ê²€ì‚¬ ë° ì¸¡ì • ì¥ë¹„'},
    {PM_ID: 'PM007', Process_Name: 'ì¡°ë¦½', Machine_Name: 'ì¡°ë¦½ê¸°', Standard_Cycle_Time: 1200, Description: 'ë¶€í’ˆ ì¡°ë¦½ ë° ê²°í•© ì¥ë¹„'},
    {PM_ID: 'PM008', Process_Name: 'í¬ì¥', Machine_Name: 'í¬ì¥ê¸°', Standard_Cycle_Time: 600, Description: 'ìë™ í¬ì¥ ë° ë°€ë´‰ ì¥ë¹„'}
];

// --- API ì„¤ì • ---
const API_CONFIG = {
    BASE_URL: 'http://127.0.0.1:8080/api',  // ì‹¤ì œ Spring Boot ì„œë²„ URLë¡œ ë³€ê²½
    ENDPOINTS: {
        DASHBOARD_SUMMARY: '/main-dashboard/summary'
    },
    // API ìš”ì²­ ê°„ê²© (ë°€ë¦¬ì´ˆ)
    UPDATE_INTERVAL: 5000
};

// --- ë°ì´í„° ì €ì¥ ê°ì²´ ---
let appData = {
    dashboardData: {
        total_operation_rate: 0,
        operating_machines: 0,
        daily_total_production: 0,
        factory_temperature: '',
        factory_humidity: '',
        total_power_consumption: 0,
        target: 1100  // í•˜ë“œì½”ë”©ëœ ëª©í‘œê°’
    }
};

// --- API í˜¸ì¶œ í•¨ìˆ˜ë“¤ ---
async function fetchFromAPI(endpoint) {
    try {
        const response = await fetch(`${API_CONFIG.BASE_URL}${endpoint}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                // í•„ìš”ì‹œ ì¸ì¦ í—¤ë” ì¶”ê°€
                // 'Authorization': `Bearer ${token}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error(`API í˜¸ì¶œ ì˜¤ë¥˜ (${endpoint}):`, error);
        // ì˜¤ë¥˜ ì‹œ ë”ë¯¸ ë°ì´í„° ë°˜í™˜ ë˜ëŠ” ìºì‹œëœ ë°ì´í„° ì‚¬ìš©
        return getFallbackData(endpoint);
    }
}

// API ì˜¤ë¥˜ ì‹œ ì‚¬ìš©í•  ê¸°ë³¸ ë°ì´í„°
function getFallbackData(endpoint) {
    const fallbackData = {
        '/main-dashboard/summary': {
            total_operation_rate: 84.2,
            operating_machines: 6,
            daily_total_production: 847,
            factory_temperature: '23.4Â°C',
            factory_humidity: '58.2%',
            total_power_consumption: 245.7
        }
    };
    
    return fallbackData[endpoint] || {};
}

// ëª¨ë“  ë°ì´í„°ë¥¼ í•œë²ˆì— ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
async function fetchAllData() {
    try {
        const dashboardData = await fetchFromAPI(API_CONFIG.ENDPOINTS.DASHBOARD_SUMMARY);

        if (dashboardData) {
            // ì „ì—­ appData ê°ì²´ ì—…ë°ì´íŠ¸
            appData.dashboardData = {
                ...appData.dashboardData,
                ...dashboardData
            };

            // UI ì—…ë°ì´íŠ¸
            updateAllUI();
        }
        
    } catch (error) {
        console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
        showErrorMessage('ë°ì´í„° ì—°ê²°ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// íŠ¹ì • ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ë“¤
async function updateDashboardData() {
    const data = await fetchFromAPI(API_CONFIG.ENDPOINTS.DASHBOARD_SUMMARY);
    if (data) {
        appData.dashboardData = { ...appData.dashboardData, ...data };
        updateAllUI();
    }
}

// --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ ---
function updateAllUI() {
    updateProductionUI();
    updateEnvironmentUI();
    updateChart();
}

function updateProductionUI() {
    const { daily_total_production, target, total_operation_rate } = appData.dashboardData;
    
    const progressPercent = Math.min(100, (daily_total_production / target) * 100);
    
    const dailyProdElement = document.getElementById('dailyProduction');
    const progressElement = document.getElementById('progressFill');
    const efficiencyElement = document.getElementById('overallEfficiency');
    
    if (dailyProdElement) {
        dailyProdElement.textContent = `${daily_total_production} / ${target}`;
    }
    if (progressElement) {
        progressElement.style.width = `${progressPercent}%`;
    }
    if (efficiencyElement) {
        efficiencyElement.textContent = `${total_operation_rate}%`;
    }
}

function updateEnvironmentUI() {
    const { factory_temperature, factory_humidity, total_power_consumption } = appData.dashboardData;
    
    const tempElement = document.getElementById('temperature');
    const humidityElement = document.getElementById('humidity');
    const powerElement = document.getElementById('powerConsumption'); 
    
    if (tempElement) {
        tempElement.textContent = factory_temperature;
    }
    if (humidityElement) {
        humidityElement.textContent = factory_humidity;
    }
    if (powerElement) {
        powerElement.textContent = `${total_power_consumption} kW`;
    }
}

function updateChart() {
    const chartContainer = document.getElementById('productionChart');
    if (!chartContainer) return;
    
    // ë”ë¯¸ ì°¨íŠ¸ ë°ì´í„° ìƒì„± (ì‹¤ì œë¡œëŠ” APIì—ì„œ ë°›ì•„ì˜¬ ìˆ˜ ìˆìŒ)
    const chartData = [
        { value: 42, height: 120 }, { value: 38, height: 90 }, { value: 51, height: 150 },
        { value: 45, height: 100 }, { value: 49, height: 140 }, { value: 41, height: 95 },
        { value: 47, height: 130 }
    ];
    
    chartContainer.innerHTML = '';
    chartData.forEach((bar) => {
        const barElement = document.createElement('div');
        barElement.className = 'chart-bar';
        barElement.style.height = bar.height + 'px';
        barElement.textContent = bar.value;
        chartContainer.appendChild(barElement);
    });
}

function showErrorMessage(message) {
    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ë¡œì§
    console.error(message);
    // ì‹¤ì œ êµ¬í˜„ì‹œì—ëŠ” UIì— ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ ì¶”ê°€
}

// --- ì´ˆê¸°í™” í•¨ìˆ˜ ---
function initialize() {
    console.log('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘...');
    
    updateTime();
    setInterval(updateTime, 1000);
    
    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    fetchAllData();
    
    // ì£¼ê¸°ì  ë°ì´í„° ì—…ë°ì´íŠ¸ ì„¤ì •
    setInterval(fetchAllData, API_CONFIG.UPDATE_INTERVAL);
    
    // 3D ë·°ì–´ ì´ˆê¸°í™”
    setTimeout(() => {
        if (typeof THREE !== 'undefined') {
            initFactoryView(); 
        } else {
            console.warn('Three.jsë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 3D ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
        }
    }, 500);
    
    window.addEventListener('resize', handleResize);
    console.log('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì™„ë£Œ!');
}

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', initialize);

// --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ ---
function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleString('ko-KR');
}

function setActiveTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');
}

// --- 3D ë·°ì–´ ì œì–´ í•¨ìˆ˜ë“¤ ---
function toggleAnimation() {
    animationRunning = !animationRunning;
    const btn = document.getElementById('animationBtn');
    if (animationRunning) {
        btn.textContent = 'â¸ï¸ ì¼ì‹œì •ì§€';
        animate();
    } else {
        btn.textContent = 'â–¶ï¸ ì‹œì‘';
        cancelAnimationFrame(animationId);
    }
}

function zoomIn() {
    if (controls) {
        controls.dollyIn(1.2);
    }
}

function zoomOut() {
    if (controls) {
        controls.dollyOut(1.2);
    }
}

function openFullscreenView() {
    // 'view.html' íŒŒì¼ì´ ì œê³µë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì´ ê¸°ëŠ¥ì€ í˜„ì¬ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    window.open('view.html', '_blank');
}

// --- 3D íŒ©í† ë¦¬ ë·° ê´€ë ¨ í•¨ìˆ˜ ---
function initFactoryView() {
    try {
        const container = document.getElementById('factoryViewer');
        if (!container) return;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a2a3a);
        scene.fog = new THREE.Fog(0x1a2a3a, 30, 100);

        camera = new THREE.PerspectiveCamera(60, container.offsetWidth / container.offsetHeight, 0.1, 1000);
        camera.position.set(0, 15, 30);
        camera.lookAt(0, 0, 0);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.offsetWidth, container.offsetHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        container.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.minDistance = 5;
        controls.maxDistance = 50;
        controls.maxPolarAngle = Math.PI / 2;

        scene.add(new THREE.AmbientLight(0x404040, 1.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(10, 20, 5);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const floorGeom = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({ color: 0x2c3e50, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeom, floorMat);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        createMachines();
        scene.add(factoryObjects);

        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();
        container.addEventListener('click', onMouseClick);
        
        animate();
        console.log('3D Factory ì´ˆê¸°í™” ì™„ë£Œ');
    } catch (error) {
        console.error('3D ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    }
}

function createMachines() {
    const machineLayout = {
        'ì£¼ì¡°': { x: -20, z: -5, count: 0 },
        'ê°€ê³µ': { x: -5, z: -5, count: 0 },
        'ê²€ì‚¬': { x: 10, z: 0, count: 0 },
        'ì¡°ë¦½': { x: 20, z: 0, count: 0 },
        'í¬ì¥': { x: 20, z: 10, count: 0 }
    };

    processMachineInfo.forEach(data => {
        const layout = machineLayout[data.Process_Name];
        if (!layout) return;

        let machine;
        switch (data.Process_Name) {
            case 'ì£¼ì¡°': machine = createCastingMachine(); break;
            case 'ê°€ê³µ': machine = createProcessingMachine(); break;
            case 'ê²€ì‚¬': machine = createInspectionMachine(); break;
            case 'ì¡°ë¦½': machine = createAssemblyMachine(); break;
            case 'í¬ì¥': machine = createPackagingMachine(); break;
        }

        if (machine) {
            machine.position.set(layout.x, 0, layout.z + layout.count * 8);
            machine.userData = data;
            
            // ë¼ë²¨ ê¸°ëŠ¥ì€ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë‚˜, í˜„ì¬ëŠ” ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
            // í•„ìš”ì‹œ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
            // const label = createLabel(data.Machine_Name);
            // label.position.set(0, 5, 0);
            // machine.add(label);

            factoryObjects.add(machine);
            layout.count++;
        }
    });
}

function createLabel(text) {
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    context.font = 'Bold 40px Arial';
    context.fillStyle = 'rgba(255,255,255,0.95)';
    context.fillText(text, 0, 40);
    
    const texture = new THREE.CanvasTexture(canvas);
    const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true });
    const sprite = new THREE.Sprite(spriteMaterial);
    sprite.scale.set(10, 5, 1.0);
    return sprite;
}

function createCastingMachine() {
    const group = new THREE.Group();
    const baseMat = new THREE.MeshStandardMaterial({ color: 0x5a6d7c });
    const furnaceMat = new THREE.MeshStandardMaterial({ color: 0xe74c3c });
    const base = new THREE.Mesh(new THREE.BoxGeometry(6, 4, 6), baseMat);
    base.position.y = 2;
    group.add(base);
    const furnace = new THREE.Mesh(new THREE.CylinderGeometry(2, 2.2, 3, 32), furnaceMat);
    furnace.position.y = 5.5;
    group.add(furnace);
    return group;
}

function createProcessingMachine() {
    const group = new THREE.Group();
    const baseMat = new THREE.MeshStandardMaterial({ color: 0x7f8c8d });
    const movingMat = new THREE.MeshStandardMaterial({ color: 0x3498db });
    const base = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 4), baseMat);
    base.position.y = 1.5;
    group.add(base);
    const arm = new THREE.Mesh(new THREE.BoxGeometry(1, 4, 1), movingMat);
    arm.position.set(0, 3, 0);
    group.add(arm);
    return group;
}

function createInspectionMachine() {
    const group = new THREE.Group();
    const tableMat = new THREE.MeshStandardMaterial({ color: 0xbdc3c7 });
    const scannerMat = new THREE.MeshStandardMaterial({ color: 0x2ecc71 });
    const table = new THREE.Mesh(new THREE.BoxGeometry(6, 0.5, 4), tableMat);
    table.position.y = 2;
    group.add(table);
    const scannerArm = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 0.5), scannerMat);
    scannerArm.position.set(-2.5, 3.5, 0);
    group.add(scannerArm);
    const scannerHead = new THREE.Mesh(new THREE.BoxGeometry(5, 0.5, 0.5), scannerMat);
    scannerHead.position.set(0, 5, 0);
    group.add(scannerHead);
    return group;
}

function createAssemblyMachine() {
    const group = new THREE.Group();
    const baseMat = new THREE.MeshStandardMaterial({ color: 0x95a5a6 });
    const robotMat = new THREE.MeshStandardMaterial({ color: 0xf39c12 });
    const base = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 1, 32), baseMat);
    base.position.y = 0.5;
    group.add(base);
    const arm1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 3, 0.5), robotMat);
    arm1.position.y = 2.5;
    group.add(arm1);
    const arm2 = new THREE.Mesh(new THREE.BoxGeometry(2, 0.5, 0.5), robotMat);
    arm2.position.set(1, 4, 0);
    group.add(arm2);
    return group;
}

function createPackagingMachine() {
    const group = new THREE.Group();
    const conveyorMat = new THREE.MeshStandardMaterial({ color: 0x34495e });
    const machineMat = new THREE.MeshStandardMaterial({ color: 0x8e44ad });
    const conveyor = new THREE.Mesh(new THREE.BoxGeometry(10, 0.5, 3), conveyorMat);
    conveyor.position.y = 1;
    group.add(conveyor);
    const machine = new THREE.Mesh(new THREE.BoxGeometry(3, 4, 4), machineMat);
    machine.position.y = 3;
    group.add(machine);
    return group;
}

function onMouseClick(event) {
    const container = document.getElementById('factoryViewer');
    const rect = container.getBoundingClientRect();
    mouse.x = ((event.clientX - rect.left) / container.clientWidth) * 2 - 1;
    mouse.y = -((event.clientY - rect.top) / container.clientHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);
    const intersects = raycaster.intersectObjects(factoryObjects.children, true);

    if (intersects.length > 0) {
        let object = intersects[0].object;
        while (object.parent && !object.userData.PM_ID) {
            object = object.parent;
        }
        if (object.userData.PM_ID) {
            highlightObject(object);
            updateInfoPanel(object.userData);
        }
    } else {
        highlightObject(null);
        updateInfoPanel(null);
    }
}

function highlightObject(object) {
    if (selectedObject) {
        selectedObject.traverse(child => {
            if (child.isMesh) {
                child.material.emissive.setHex(initialColors.get(child.uuid) || 0x000000);
            }
        });
    }

    selectedObject = object;

    if (selectedObject) {
        selectedObject.traverse(child => {
            if (child.isMesh) {
                initialColors.set(child.uuid, child.material.emissive.getHex());
                child.material.emissive.setHex(0x555555);
            }
        });
    }
}

function updateInfoPanel(data) {
    const panel = document.getElementById('machineInfoPanel');
    if (data) {
        panel.innerHTML = `
            <strong>ID:</strong> ${data.PM_ID}<br>
            <strong>ì´ë¦„:</strong> ${data.Machine_Name}<br>
            <strong>ê³µì •:</strong> ${data.Process_Name}<br>
            <strong>í‘œì¤€ ì‚¬ì´í´ íƒ€ì„:</strong> ${data.Standard_Cycle_Time}s<br>
            <strong>ì„¤ëª…:</strong> ${data.Description}
        `;
        panel.classList.remove('hidden');
    } else {
        panel.classList.add('hidden');
    }
}

function animate() {
    if(animationRunning) {
      animationId = requestAnimationFrame(animate);
    }
    if(controls) controls.update();
    if(renderer) renderer.render(scene, camera);
}

function selectLine(lineId) {
    selectedLine = lineId;
    const lineButtons = document.querySelectorAll('.line-btn');
    lineButtons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    updateLineData(lineId);
}

function updateLineData(lineId) {
    const lineDetailContent = document.getElementById('lineDetailContent');
    const lineDataMap = {
        casting: `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì£¼ì¡° ë¼ì¸ - ìƒì‚° í˜„í™©</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ì‹œê°„ë‹¹ ìƒì‚°ëŸ‰</span>
                    <span class="metric-value">47ê°œ</span>
                </div>
                <div class="metric">
                    <span>ê°€ë™ë¥ </span>
                    <span class="metric-value">89.2%</span>
                </div>
                <div class="metric">
                    <span>ë¶ˆëŸ‰ë¥ </span>
                    <span class="metric-value">2.1%</span>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì„¤ë¹„ë³„ ìƒíƒœ</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ìš©í•´ë¡œ ì˜¨ë„</span>
                    <span class="metric-value">742Â°C</span>
                </div>
                <div class="metric">
                    <span>ì£¼ì¡° ì••ë ¥</span>
                    <span class="metric-value">85 bar</span>
                </div>
                <div class="metric">
                    <span>ëƒ‰ê° ì‹œê°„</span>
                    <span class="metric-value">12.3ë¶„</span>
                </div>
            </div>
        `,
        machining: `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ê°€ê³µ ë¼ì¸ - ìƒì‚° í˜„í™©</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ì‹œê°„ë‹¹ ìƒì‚°ëŸ‰</span>
                    <span class="metric-value">55ê°œ</span>
                </div>
                <div class="metric">
                    <span>ê°€ë™ë¥ </span>
                    <span class="metric-value">91.5%</span>
                </div>
                <div class="metric">
                    <span>ë¶ˆëŸ‰ë¥ </span>
                    <span class="metric-value">0.9%</span>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì„¤ë¹„ë³„ ìƒíƒœ</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>CNC ìŠ¤í•€ë“¤ ì†ë„</span>
                    <span class="metric-value">12,000 RPM</span>
                </div>
                <div class="metric">
                    <span>ì ˆì‚­ìœ ëŸ‰</span>
                    <span class="metric-value">25 L/min</span>
                </div>
            </div>
        `,
        inspection: `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ê²€ì‚¬ ë¼ì¸ - ìƒì‚° í˜„í™©</div>
                    <div class="status-indicator status-warning"></div>
                </div>
                <div class="metric">
                    <span>ì‹œê°„ë‹¹ ì²˜ë¦¬ëŸ‰</span>
                    <span class="metric-value">60ê°œ</span>
                </div>
                <div class="metric">
                    <span>ê°€ë™ë¥ </span>
                    <span class="metric-value">78.0%</span>
                </div>
                <div class="metric">
                    <span>ë¶ˆëŸ‰ ë°œê²¬ìœ¨</span>
                    <span class="metric-value">99.5%</span>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì„¤ë¹„ë³„ ìƒíƒœ</div>
                    <div class="status-indicator status-warning"></div>
                </div>
                <div class="metric">
                    <span>ê²€ì‚¬ê¸° #2 ì§„ë™</span>
                    <span class="metric-value">ì´ìƒ (Warning)</span>
                </div>
                <div class="metric">
                    <span>ì„¼ì„œ ë¯¼ê°ë„</span>
                    <span class="metric-value">ì •ìƒ</span>
                </div>
            </div>
        `,
        assembly: `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì¡°ë¦½ ë¼ì¸ - ìƒì‚° í˜„í™©</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ì‹œê°„ë‹¹ ì¡°ë¦½ëŸ‰</span>
                    <span class="metric-value">40ê°œ</span>
                </div>
                <div class="metric">
                    <span>ê°€ë™ë¥ </span>
                    <span class="metric-value">85.5%</span>
                </div>
                <div class="metric">
                    <span>ì¡°ë¦½ë¶ˆëŸ‰ë¥ </span>
                    <span class="metric-value">0.5%</span>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì„¤ë¹„ë³„ ìƒíƒœ</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ë¡œë´‡ íŒ” ìƒíƒœ</span>
                    <span class="metric-value">ì •ìƒ</span>
                </div>
                <div class="metric">
                    <span>í† í¬ ê°’</span>
                    <span class="metric-value">ê¸°ì¤€ì¹˜ ë‚´</span>
                </div>
            </div>
        `,
        packaging: `
            <div class="card">
                <div class="card-header">
                    <div class="card-title">í¬ì¥/ì¶œí•˜ ë¼ì¸ - ìƒì‚° í˜„í™©</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ì‹œê°„ë‹¹ í¬ì¥ëŸ‰</span>
                    <span class="metric-value">65ê°œ</span>
                </div>
                <div class="metric">
                    <span>ê°€ë™ë¥ </span>
                    <span class="metric-value">95.0%</span>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ì„¤ë¹„ë³„ ìƒíƒœ</div>
                    <div class="status-indicator status-good"></div>
                </div>
                <div class="metric">
                    <span>ì»¨ë² ì´ì–´ ì†ë„</span>
                    <span class="metric-value">1.2 m/s</span>
                </div>
                <div class="metric">
                    <span>í¬ì¥ì¬ ì”ëŸ‰</span>
                    <span class="metric-value">70%</span>
                </div>
            </div>
        `
    };
    lineDetailContent.innerHTML = lineDataMap[lineId] || lineDataMap.casting;
}

function selectEquipment(equipmentId) {
    console.log('Selected equipment:', equipmentId);
    alert(`${equipmentId} ì¥ë¹„ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`);
}

function handleResize() {
    if (camera && renderer) {
        const container = document.getElementById('factoryViewer'); 
        if (container) {
            camera.aspect = container.offsetWidth / container.offsetHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.offsetWidth, container.offsetHeight);
        }
    }
}

window.addEventListener('beforeunload', () => {
    if (animationId) {
        cancelAnimationFrame(animationId);
    }
    if (renderer) {
        renderer.dispose();
    }
});
    </script>
</body>
</html>